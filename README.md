# Zuzu Bot - Бот для сбора данных о сайтах

Этот Telegram бот предназначен для парсинга цен товаров с различных веб-сайтов. Пользователь предоставляет боту Excel файл со списком сайтов и XPath для элементов цен, а бот сохраняет эту информацию в базу данных, парсит сайты, и возвращает средние цены.

## Структура Проекта

Проект имеет следующую структуру:

- `bot/`: Директория, содержащая код, связанный с Telegram ботом.
  - `handlers/`: Обработчики команд и сообщений бота.
    - `basic.py`: Основные обработчики (старт, помощь, обработка документов).
  - `bot.py`: Инициализация бота, диспетчера и запуск polling.
- `data/`: Директория для хранения данных (база данных SQLite).
  -  В этой директории создается `zuzu_bot.db` после первого запуска.
- `db/`: Модули для работы с базой данных.
  - `database.py`: Функции для инициализации БД, сохранения и извлечения данных.
- `parser/`: Модуль парсинга.
  - `parser.py`: Функции для парсинга веб-страниц с использованием Selenium и расчета средних цен.
- `test/`: Модуль с pytest тестами.
    - `test_excel.py`: Тесты для функционала бота.
- `.env`: Файл с переменными окружения (токен бота). *Необходимо создать и добавить `BOT_TOKEN`.*
- `config.py`: Файл конфигурации (загрузка переменных окружения).
- `requirements.txt`: Список зависимостей Python.
- `README.md`: Этот файл.

## Подготовка к Работе

1.  **Клонирование репозитория:**

    ```bash
    git clone <ссылка на репозиторий>
    cd <имя папки репозитория>
    ```

2.  **Установка зависимостей:**

    ```bash
    pip install -r requirements.txt
    ```

3.  **Настройка переменных окружения:**

    -   Создайте файл `.env` в корне проекта.
    -   Добавьте в `.env` переменную `BOT_TOKEN` с токеном вашего Telegram бота:
        ```
        BOT_TOKEN=your_bot_token_here
        ```
    - Замените  `your_bot_token_here`  на настоящий токен, полученный от  `@BotFather`  в Telegram.

4. **Пример Excel файла**

   В репозитории есть пример файла `example.xlsx`, который можно использовать для тестирования бота. В этом файле находятся сайты, к которым на данный момент бот может подключиться и распарсить цены.

## Запуск Бота

Выполните следующую команду в корне проекта:

```bash
python bot/bot.py
```

## Использование Бота

1.  **Запустите бота в Telegram:** Найдите своего бота в Telegram и нажмите "Start" (или отправьте команду `/start`).

2.  **Отправьте Excel файл:** Отправьте боту файл Excel, соответствующий формату, описанному ниже.

3.  **Получите результаты:** Бот обработает файл, сохранит данные в базу, выполнит парсинг и отправит вам средние цены по каждому сайту.

## Формат Excel Файла

Excel файл должен иметь следующие колонки:

-   `title`: Название сайта (например, "Ситилинк").
-   `url`: Полный URL сайта (например, "https://www.citilink.ru").
-   `xpath`: XPath выражение для элемента, содержащего цену (например, `//span[@class='price']`).

**Пример содержимого файла:**

| title     | url                       | xpath                                                                                                                                                                                                                                                                                                             |
| --------- | ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Ситилинк | https://www.citilink.ru/catalog/noutbuki/?ref=mainpage_popular | //span[@class='e4ahr150 e1a7a4n70 app-catalog-1dno20p-StyledTypography--getTypographyStyle-composeBreakpointsStyles--arrayOfStylesByBreakpoints-StyledText--getTextStyle-Text--StyledTextComponent-MainPriceNumber--StyledMainPriceNumber ez8h4tf0']                                                                                                                                                                |

## Команды Бота

-   `/start`:  Начать работу с ботом, получить приветственное сообщение и инструкции.
-   `/help`:  Получить подробную инструкцию по использованию бота.

## Тестирование

Для запуска тестов выполните:

```bash
pytest test/test_excel.py
```

## Ограничения и Известные Проблемы

-   **Таймауты:** Во время разработки часто возникали таймауты при попытках парсинга разных сайтов.  Это связано с тем, что сайты могут использовать различные техники защиты от парсинга (Cloudflare, ограничения по IP, динамическая загрузка контента и т.д.).  Успешное подключение и парсинг гарантируются *только* для сайта, указанного в примере Excel файла (`example.xlsx`).
-   **Зависимость от структуры сайта:** XPath выражения жёстко привязаны к структуре HTML кода сайта. Если сайт изменит свою разметку, XPath, скорее всего, перестанет работать, и его нужно будет обновить.
- **Обработка ошибок:** В текущей реализации бот обрабатывает основные исключения, но могут возникать непредвиденные ошибки, связанные с парсингом, особенно если сайт использует сложные технологии защиты.

## Возможные Улучшения

-   **Более надежный парсинг:**
    -   Использование прокси-серверов для обхода ограничений по IP.
    -   Реализация механизма повторных попыток с задержкой при таймаутах.
    -   Использование более продвинутых методов обхода защиты от парсинга (например, эмуляция действий пользователя, решение CAPTCHA).
-   **Улучшенная обработка ошибок:**
    -   Более детальное логирование ошибок для упрощения отладки.
    -   Отправка пользователю более информативных сообщений об ошибках.
    -   Реализация механизма оповещения администратора бота о критических ошибках.
-   **Дополнительные возможности:**
    -   Добавление возможности указывать название товара в Excel файле (сейчас парсится все по XPath).
    -   Поддержка других форматов файлов (например, CSV).
    -   Реализация периодического автоматического парсинга цен.
    -   Добавление возможности удаления сайтов из базы данных.
    -   Реализация веб-интерфейса для управления ботом и просмотра данных.
- **Асинхронность парсера**: Переписать `parser.py` для асинхронной работы (например с использованием `aiohttp` вместо `selenium`), что позволит парсить несколько сайтов одновременно, значительно увеличив производительность.
- **Контейнеризация**: Использовать Docker для упрощения развертывания и запуска бота.
